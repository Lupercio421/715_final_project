---
title: "NYC EMS Response times"
author: "Daniel L."
date: "3/25/2021"
output: html_document
---

```{r, error = FALSE, message=FALSE}
library(tidyverse)
library(lubridate)
library(fable)
library(TSA)
#load forescasting package
library(fpp2)
```


```{r}
data_911 <- read.csv("/Users/daniel421/Desktop/R/STAT_715/911_End-to-End_Data.csv", header= TRUE)
```


```{r}
#str(data_911);
```
We see that the data is a character, so I will work on making it a POSIX

```{r}
data_911[,1] <- mdy(data_911[,1])
```


Let us Isolate the 3 major Agencies right away

#### EMS

```{r}
EMS_data <- data_911 %>% filter(Agency == "EMS")
```

```{r}
EMS_data <- EMS_data[,-c(7,8,16,17,29,30)]
```

#### NYPD

```{r}
NYPD_data <- data_911 %>% filter(Agency == "NYPD")
```

```{r}
NYPD_data <- NYPD_data[,-c(7,8,9,10,16,17,18,19,25,26,29,30)]
```

### FDNY

```{r}
FDNY_data <- data_911 %>% filter(Agency == "FDNY")
```


```{r}
#filter(MONTH >= as.Date("2017-01-01") & MONTH <= as.Date("2017-12-01"))
#FDNY_data %>% filter(Final_Incident_Type == "1. Structural Fires") %>% filter(Week_Start_Date >= as.Date("2014-01-06") & Week_Start_Date <= as.Date("2014-12-29"))
```

```{r}
#FDNY_data %>% filter(Final_Incident_Type == "1. Structural Fires") %>% filter(Week_Start_Date >= as.Date("2015-01-05") & Week_Start_Date <= as.Date("2015-12-28"))
```
```{r}
#FDNY_data %>% filter(Final_Incident_Type == "1. Structural Fires") %>% filter(Week_Start_Date >= as.Date("2016-01-04") & Week_Start_Date <= as.Date("2016-12-26"))
```
```{r}
#FDNY_data %>% filter(Final_Incident_Type == "1. Structural Fires") %>% filter(Week_Start_Date >= as.Date("2017-01-02") & Week_Start_Date <= as.Date("2017-12-25"))
```

```{r}
#FDNY_data %>% filter(Final_Incident_Type == "1. Structural Fires") %>% filter(Week_Start_Date >= as.Date("2017-01-04") & Week_Start_Date <= as.Date("2019-12-30"))
```

2015 ["2015-01-05" - "2015-12-28"] -> 52

2016 ["2016-01-04" - "2016-12-26"] -> 52

2017 ["2017-01-02" - "2017-12-25"] -> 52

2018["2018-01-01" - "2018-12-24"] -> 52 week observations

2019["2018-12-31" - "2019-12-23"] -> 52 week observations

```{r}
#FDNY_data %>% filter(Week_Start_Date >= as.Date("2014-01-06") & Week_Start_Date <= as.Date("2014-12-29")) 
```
# NYPD

```{r}
#NYPD_data %>% filter(Week_Start_Date >= as.Date("2014-01-06") & Week_Start_Date <= as.Date("2020-08-24"))
```
Best to exclude 2013 and 2014

Let us check to see if Jan of 2015 through Dec of 2019 gives us 780 rows

2015, 2016, 2017 has 52 week observations

2018["2018-01-01" - "2018-12-24"] -> 52 week observations

2019["2018-12-31" - "2019-12-23"] -> 52 week observations


```{r}
#NYPD_data %>% filter(Week_Start_Date >= as.Date("2018-12-31") & Week_Start_Date <= as.Date("2019-12-23"))
```

# EMS

2015,2016, 2017, 2018 has 52 observations for each incident type

2018["2018-01-01" - "2018-12-24"] -> 52 week observations

2019["2018-12-31" - "2019-12-30"] -> 53 week observations

2019["2019-01-07" - "2019-12-30"] -> 52 week observations

2019["2018-12-31" - "2019-12-23"] -> 52 week observations


```{r}
#EMS_data %>% filter(Week_Start_Date >= as.Date("2018-12-31") & Week_Start_Date <= as.Date("2019-12-23"))
```

```{r}
#EMS_data %>% filter(Week_Start_Date >= as.Date("2020-01-06") & Week_Start_Date <= as.Date("2020-08-24"))
```

# THIS 911 data will be from "2015-01-05" through "2019-12-23". The years 2015 through 2019 will have 52 weekly observations, per year.


```{r}
data_911 <- data_911 %>% arrange(ymd(data_911$Week_Start_Date))

data_911 <- data_911 %>% filter(Week_Start_Date >= as.Date("2015-01-05") & Week_Start_Date <= as.Date("2019-12-23")) 
```


Let us Isolate the 3 major Agencies again

#### EMS

```{r}
EMS_data <- data_911 %>% filter(Agency == "EMS")
```

```{r}
EMS_data <- EMS_data[,-c(7,8,16,17,29,30)]
```


#### NYPD

```{r}
NYPD_data <- data_911 %>% filter(Agency == "NYPD")
```

```{r}
NYPD_data <- NYPD_data[,-c(7,8,9,10,16,17,18,19,25,26,29,30)]
```

### FDNY

```{r}
FDNY_data <- data_911 %>% filter(Agency == "FDNY")
```

It is up to me if the start and end dates should be "2015-01-05" through "2019-12-30" or whether it should be "2015-01-05" through "2020-08-24"

```{r}
class(EMS_data)
```

```{r}
#ts(new_EMS_data[,c(3,10)], freq = 365.25/7, start = decimal_date(ymd("2015-01-05")))
```

## EMS Part 2

## Life Threatening Emergencies

```{r}
EMS_final_1 <- EMS_data %>% filter(Final_Incident_Type == "1. Life Threating Med Emergencies"); 
#EMS_final_1[,10]
```

```{r}
#(ymd(EMS_final_1[1,1])
ts_EMS_final_1 <- ts(EMS_final_1[,10], freq = 365.25/7, start = 2015+0/365.25)
```


```{r}
plot(ts_EMS_final_1)
```

It seems that I have gotten my time series data starting with the first week of 2015 through the final week of 2019. I will begin the forecasting process using material from fpp2 package. 

```{r}
#Time plot
autoplot(ts_EMS_final_1) +
  ggtitle("Life Threatening Medical Emergencies: First Call to EMS arrival" )+
  ylab("Seconds")
```

We see a decreasing trend in call to arrival time from 2015 through mid 2017, then we see an increasing trend all the way through the end of 2019. We can assume that at the start of every year, call to arrival time are high for the new years celebrations.

### Let us difference this data once

```{r}
ts_EMS_final_1_diff <- diff(ts_EMS_final_1)
autoplot(ts_EMS_final_1_diff) +
  ggtitle("DifferencedLife Threatening Medical Emergencies: First Call to EMS arrival" )+
  ylab("Seconds")
```

The trend is removed, fluctuations do exist. Now, assuming this new series is stationary, let us investigate seasonality.

```{r}
ggseasonplot(ts_EMS_final_1_diff) + ggtitle("Seasonal Plot: Change in First Call to EMS arrival") + ylab("Seconds")
```

```{r}
#ggsubseriesplot(ts_EMS_final_1_diff) + ggtitle("Seasonal subseries plot: Change in First Call to EMS arrival") + ylab("Seconds")
```

```{r}
gglagplot(ts_EMS_final_1_diff, lags = 4, set.lags = 1:4, sesaonal = FALSE, do.lines = FALSE) + ggtitle("Lag Plot") + theme(legend.title = element_blank())
```

Here, we can not specify a positive or negative linear trend. 

### Autorcorrelation Plot

```{r}
ggAcf(ts_EMS_final_1_diff) + ggtitle("Autocorrelation Plot: Differenced Life Threatening Emergencies Time Series")
```

Lags 1 and 2 go beyond the 95% confidence intervals.

## Benchmark method to forecast

### Let's use the seasonal naive method as our benchmark

$y_t = y_{t-s}+e_t$

We would like to use the difference data

```{r}
#ts_EMS_final_1_diff_fit_snaive <- snaive(ts_EMS_final_1_diff);
#print(summary(ts_EMS_final_1_diff_fit_snaive))
```

Residual standard deviation = 28.5456


### Let us model the differenced data with ARIMA

```{r}
#ts_EMS_final_1_diff_fit_arima <- auto.arima(ts_EMS_final_1_diff, stepwise = FALSE, approximation = FALSE, trace = TRUE);
#print(summary(ts_EMS_final_1_diff_fit_arima))
```
```{r, echo = FALSE}
ts_EMS_final_1_fit_arima <- auto.arima(ts_EMS_final_1, d = 1, stepwise = FALSE, approximation = FALSE, trace = TRUE);
```
```{r}
print(summary(ts_EMS_final_1_fit_arima))
```

```{r}
checkresiduals(ts_EMS_final_1_fit_arima)
```
The number of lags used is 52, so our degrees of freedom for the residuals is 52-3-1 = 48. The upper tail $\chi^2$ evaluated at $\alpha = .05$ with 48 degrees of freedom is 65.171. Our test statistic, Q* = 41.052 is > 65.171. 

$H_0$: This ARIMA(3,1,1) model does not exhibit lack of fit. Compared to $H_a$: This model exhibits lack of fit.

Out test statistic tells us to reject the null hypothesis, and conclude $H_a$. This model has significant lack of fit.

# Left off here 04/14/21

```{r}
#autoplot(ts_EMS_final_1_fit_arima)
```


## Non-Life Threatening Emergencies
```{r}
EMS_final_2 <- EMS_data %>% filter(Final_Incident_Type == "2. Non-Life Threatening Med Emergencies") 
ts_EMS_final_2 <- ts(EMS_final_2[,10], freq = 365.25/7, start = 2015+0/365.25)
```

```{r}
autoplot(ts_EMS_final_2) +
  ggtitle("Non-Life Threatening Medical Emergencies: First Call to EMS arrival")+
  ylab("Seconds")
```

These calls begin at a longer wait time. Like the life threatening medical emergencies, we see a similar trend.

```{r}
#ts.plot(ts_EMS_final_1, ts_EMS_final_2,
#        gpars=list(xlab="Time", ylab="Seconds", col = c("red", "blue")))
#title("EMS Time Series")
#legend()
```
```{r}
#ts_EMS_final_1_diff_fit %>% glance()
```
 

## NYPD - 1. Critical Incidents

```{r}
NYPD_data_1 <- NYPD_data %>% filter(Final_Incident_Type == "1. Critical")
ts_NYPD_data_1 <- ts(NYPD_data_1[,8], freq = 365.25/7, start = 2015+0/365.25)
```

```{r}
autoplot(ts_NYPD_data_1) +
  ggtitle("Critical Incidents: First Call to NYPD arrival" )+
  ylab("Seconds")
```

## NYPD  2. Serious Incidents 

```{r}
NYPD_data_2 <- NYPD_data %>% filter(Final_Incident_Type == "2. Serious")
ts_NYPD_data_2 <- ts(NYPD_data_2[,8], freq = 365.25/7, start = 2015+0/365.25)
```


```{r}
autoplot(ts_NYPD_data_2) +
  ggtitle("Serious Incidents: First Call to NYPD arrival" )+
  ylab("Seconds")
```

## NYPD 3. Non-Critical Incidents

```{r}
NYPD_data_3 <- NYPD_data %>% filter(Final_Incident_Type == "3. Non-Critical")

ts_NYPD_data_3 <- ts(NYPD_data_3[,8], freq = 365.25/7, start = 2015+0/365.25)

autoplot(ts_NYPD_data_3) +
  ggtitle("Non-Critical Incidents: First Call to NYPD arrival" )+
  ylab("Seconds")
```

#### Let me plot all three time series for NYPD data

```{r}
#critical, serious, non-critical
ts.plot(ts_NYPD_data_1, ts_NYPD_data_2, ts_NYPD_data_3,
        gpars=list(xlab="Time", ylab="Seconds", col = c("red", "blue", "orange")))
title("NYPD Time Series")
```


# For FDNY, we will be looking at Structural Fire  and Non-Structural Fire Incidents

## FDNY - 1. Structural Fires

```{r}
FDNY_data_1 <- FDNY_data %>% filter(Final_Incident_Type == "1. Structural Fires")

ts_FDNY_data_1 <- ts(FDNY_data_1[,12], freq = 365.25/7, start = 2015+0/365.25)

autoplot(ts_FDNY_data_1) +
  ggtitle("Structural Fires: First Call to FDNY arrival" )+
  ylab("Seconds")

```

## FDNY - 2. Structural Fires

```{r}
FDNY_data_2 <- FDNY_data %>% filter(Final_Incident_Type == "2. Non-Structural Fires")

ts_FDNY_data_2 <- ts(FDNY_data_2[,12], freq = 365.25/7, start = 2015+0/365.25)

autoplot(ts_FDNY_data_2) +
  ggtitle("Non-Structural Fires: First Call to FDNY arrival" )+
  ylab("Seconds")


```


## FDNY 3. Medical Emergencies

```{r}
#rm(FDNY_data_3, ts_)
#FDNY_data_3 <- FDNY_data %>% filter(Final_Incident_Type == "3. Medical Emergencies")

#ts_FDNY_data_3 <- ts(FDNY_data_3[,12], freq = 365.25/7, start = 2015+0/365.25)

#autoplot(ts_FDNY_data_3) +
#  ggtitle("Medical Emergencies: First Call to FDNY arrival" )+
#  ylab("Seconds")
```

